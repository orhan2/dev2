<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.82.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Deploy go fiber webapp to azure cloud from private docker hub container repo&nbsp;&ndash;&nbsp;OyunDev</title><link rel="stylesheet" href="/css/core.min.7b0b37aef2228a2d4e5bdc7ffa142bb8c43f597c8f291389cf40f21a13f8b1ab30db9580df799c419ab724f0a029dd60.css" integrity="sha384-ews3rvIiii1OW9x/&#43;hQruMQ/WXyPKROJz0DyGhP4sasw25WA33mcQZq3JPCgKd1g"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Deploy go fiber webapp to azure cloud from private docker hub container repo" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><img class="site logo" src="/assets/img/crank.svg" alt /><span class="site name">OyunDev</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a><a class="nav item" href="/about/">About</a><a class="nav item" href="https://github%2ecom/oyundev/"target="_blank" rel="noopener noreferrer">Github</a><a class="nav item" href="/index%2exml">Rss</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Deploy go fiber webapp to azure cloud from private docker hub container repo</h1><p class="article date">Aug 29, 2021<span class="reading-time"> • 8 minutes to read</span></p></section><article class="article markdown-body"><h1 id="azure-webapp-running-a-docker-container-from-your-private-docker-hub-repository">Azure WebApp running a docker container from your private docker hub repository</h1>
<p>Microsoft Azure Cloud app services allows customers to run web applications which can be deployed using docker containers residing in Azure Container Registry, Docker Hub (public or private) and other custom docker repositories.<br><br>Just like other big-cloud vendors Microsoft Azure offers a limited time free plan and an always free tier within certain limitations. You can find list of free service offers and information about limits at this <a href="https://portal.azure.com/#blade/Microsoft_Azure_Billing/FreeServicesBlade"target="_blank" rel="noopener noreferrer">azure portal free services page</a>
. You can find source code for this article on <a href="https://github.com/oyundev/tweb1"target="_blank" rel="noopener noreferrer">github here</a>
</p>
<h1 id="synopsis-and-prerequisites">Synopsis and prerequisites</h1>
<p>I wanted to create a <a href="https://github.com/gofiber/fiber"target="_blank" rel="noopener noreferrer">gofiber</a>
 webapp, running inside of a docker from scratch container, deploy and run it using azure app services and secure it using azure active directory authentication provider <a href="https://github.com/markbates/goth/tree/master/providers/azureadv2"target="_blank" rel="noopener noreferrer">goth/azureadv2</a>
. Prerequisites to do this are:</p>
<ul>
<li>Go compiler: <a href="https://golang.org/dl/">https://golang.org/dl/</a> <br></li>
<li>Docker and a free docker hub account to store my containers: <a href="https://hub.docker.com">https://hub.docker.com</a> <br></li>
<li>Microsoft Azure Cloud account: <a href="https://azure.microsoft.com">https://azure.microsoft.com</a> free tier would suffice. <br></li>
</ul>
<hr/>
End result will be a simple web page that only your default Azure AD users can login: <br> <br>
<p><img  src="/assets/img/azure-go-ad.png"
        alt="webapp-login-authenticated"/></p>
<h1 id="go-webapp-with-gofiber-and-gothazureadv2">Go webapp with gofiber and goth/azureadv2</h1>
<p>Go code for this web app fairly simple. I was getting &ldquo;Request Header Fields Too Large&rdquo; error with default gofiber config. Increasing ReadBufferSize to 16K in fiber config constructor fixed this issue. <br><br>Also goth/azureadv2 provider has a known bug getting authenticated users email address info so I used a little workaround for it. You can find full source code on <a href="https://github.com/oyundev/tweb1"target="_blank" rel="noopener noreferrer">github here</a>
.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">testparam</span> <span class="kt">string</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="o">*</span><span class="nx">flagkey</span><span class="p">))</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="nx">testparam</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="o">*</span><span class="nx">flagkey</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">options</span> <span class="o">:=</span> <span class="nx">azureadv2</span><span class="p">.</span><span class="nx">ProviderOptions</span><span class="p">{</span>
		<span class="nx">Scopes</span><span class="p">:</span> <span class="p">[]</span><span class="nx">azureadv2</span><span class="p">.</span><span class="nx">ScopeType</span><span class="p">{</span><span class="nx">azureadv2</span><span class="p">.</span><span class="nx">UserReadScope</span><span class="p">},</span>
		<span class="nx">Tenant</span><span class="p">:</span> <span class="nx">azureadv2</span><span class="p">.</span><span class="nf">TenantType</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">goth</span><span class="p">.</span><span class="nf">UseProviders</span><span class="p">(</span>
		<span class="nx">azureadv2</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">applicationID</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="nx">redirectUri</span><span class="p">,</span> <span class="nx">options</span><span class="p">),</span>
	<span class="p">)</span>

	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">fiber</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
		<span class="nx">ReadBufferSize</span><span class="p">:</span> <span class="mi">16384</span><span class="p">,</span>
	<span class="p">})</span>

	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/auth/:provider/callback&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">Ctx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gf</span><span class="p">.</span><span class="nf">CompleteUserAuth</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>

		<span class="c1">//PROVIDER-BUG:https://github.com/markbates/goth/issues/289
</span><span class="c1"></span>		<span class="kd">var</span> <span class="nx">userPrincipalName</span> <span class="kt">string</span>
		<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">dumpMap</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">RawData</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">k</span> <span class="o">==</span> <span class="s">&#34;userPrincipalName&#34;</span> <span class="p">{</span>
				<span class="nx">userPrincipalName</span> <span class="p">=</span> <span class="nx">v</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">b</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Builder</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">htmlheadsrc</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;body&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&#34;/logout/azureadv2&#34;&gt;Logout&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br/&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;`</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Email</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
			<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;Email&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">userPrincipalName</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;Email&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Email</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;Name&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;FirstName&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">FirstName</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;LastName&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">LastName</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;NickName&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">NickName</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;Description&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Description</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;UserID&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">UserID</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;AvatarURL&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">AvatarURL</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;Location&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Location</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;AccessToken&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">AccessToken</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;AccessTokenSecret&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">AccessTokenSecret</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;RefreshToken&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">RefreshToken</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;ExpiresAt&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ExpiresAt</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;IDToken&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">IDToken</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;tr&gt;&lt;td nowrap&gt;userPrincipalName&lt;/td&gt;&lt;td&gt;`</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">RawData</span><span class="p">[</span><span class="s">&#34;userPrincipalName&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span> <span class="o">+</span> <span class="s">`&lt;/td&gt;&lt;/tr&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;/tbody&gt;&lt;/table&gt;&lt;br/&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;p&gt;`</span> <span class="o">+</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;WEBSITE_HOSTNAME&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s">`&lt;/p&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;p&gt;`</span> <span class="o">+</span> <span class="nx">testparam</span> <span class="o">+</span> <span class="s">`&lt;/p&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;/body&gt;&lt;/html&gt;`</span><span class="p">)</span>

		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;text/html&#34;</span><span class="p">)</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Send</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">()))</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/logout/:provider&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">Ctx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="nx">gf</span><span class="p">.</span><span class="nf">Logout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Redirect</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/auth/:provider&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">Ctx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">authUser</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gf</span><span class="p">.</span><span class="nf">CompleteUserAuth</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">ctx</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">authUser</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">gf</span><span class="p">.</span><span class="nf">BeginAuthHandler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>
	
	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/favicon.ico&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">Ctx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="nx">buf</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">}</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;image/x-icon&#34;</span><span class="p">)</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="nx">app</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">fiber</span><span class="p">.</span><span class="nx">Ctx</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">b</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Builder</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">htmlheadsrc</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;body&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&#34;/auth/azureadv2&#34;&gt;Login&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a&gt;Logout&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;p&gt;`</span> <span class="o">+</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;WEBSITE_HOSTNAME&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s">`&lt;/p&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;p&gt;`</span> <span class="o">+</span> <span class="nx">testparam</span> <span class="o">+</span> <span class="s">`&lt;/p&gt;`</span><span class="p">)</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">`&lt;/body&gt;&lt;/html&gt;`</span><span class="p">)</span>

		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;text/html&#34;</span><span class="p">)</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">Send</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">()))</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;:80&#34;</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><h1 id="dockerfile-and-preparing-container">Dockerfile and preparing container</h1>
<p>Because we are using a scratch container we need to provide ssl certificates manually otherwise authentication will fail. To do this we use a docker multi stage build:</p>
<div class="highlight"><pre class="chroma"><code class="language-docker" data-lang="docker"><span class="k">FROM</span><span class="s"> alpine:latest as certs</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> apk --update add ca-certificates<span class="err">
</span><span class="err"></span><span class="c"># https://medium.com/on-docker/use-multi-stage-builds-to-inject-ca-certs-ad1e8f01de1b</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> scratch</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 80</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> <span class="nv">PATH</span><span class="o">=</span>/bin<span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>certs /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt<span class="err">
</span><span class="err"></span><span class="k">COPY</span> ./tweb1 /<span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/tweb1&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></div><h1 id="deploy-container-to-azure-cloud-using-portal">Deploy container to Azure Cloud using Portal</h1>
<p>At this stage we should have our app container inside our docker hub private repo. I think how to use docker and docker hub is out of scope of this post so I assume we have built our container and pushed it to our private hub repository already.<br><br>
Creating a web app at Azure Portal using web based UI is very easy. This is just a wizard type UI that you fill out some required values and click next to continue on next step until final page where you review all info and create the webapp. After that we need to configure authentication and create and Azure AD app registration for our webapp. Here steps how to to so:<br></p>
<ul>
<li>Login to Azure Portal and create a new webapp in app services.
<ul>
<li>Bear in mind free-tier may not be available in some regions, you can change the region if necessary.</li>
<li>Choose docker hub for deployment source and fill out your docker credentials.</li>
</ul>
</li>
<li>After creating webapp, go to authentication section and click to add identity provider.
<ul>
<li>This step will create active directory app registration and create access token secret for our app.</li>
<li>It is important to allow anonymous access to users so they can click login button to start the authentication process.</li>
</ul>
</li>
<li>Go to webapp configuration section and create tree new values for:
<ul>
<li>APPLICATION_ID, AD_TENANT_ID, REDIRECT_URI.</li>
<li>These are necessary values to authenticate users with Azure AD provider.</li>
<li>You should also see setting value for MICROSOFT_PROVIDER_AUTHENTICATION_SECRET already created for us when we added identity provider in previous step.</li>
</ul>
</li>
</ul>
<h1 id="deploy-using-azure-cli">Deploy using Azure CLI:</h1>
<p>Azure CLI is very powerful tool to manage azure resources. We can use it to automate deployment with CI/CD pipelines. I think easiest way to run azure cli is using docker. Run it with the command: ~$ docker run &ndash;rm -it mcr.microsoft.com/azure-cli<br><br>
This script below shows how to use cli to create webapp with container, configure environment and set up authentication:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># https://docs.microsoft.com/en-us/cli/azure/install-azure-cli</span>
<span class="c1"># https://docs.microsoft.com/en-us/cli/azure/run-azure-cli-docker</span>
<span class="c1"># Using Docker: docker run -it mcr.microsoft.com/azure-cli</span>
<span class="c1"># ~$ sudo docker run --rm -it mcr.microsoft.com/azure-cli</span>
<span class="c1"># Unable to find image &#39;mcr.microsoft.com/azure-cli:latest&#39; locally</span>
<span class="c1"># latest: Pulling from azure-cli</span>
<span class="c1"># 540db60ca938: Pull complete</span>
<span class="c1"># a7ad1a75a999: Pull complete</span>
<span class="c1"># 8d9a9d314bf5: Pull complete </span>
<span class="c1"># Digest: sha256:2090963629cc9c595bbad24354bb6879112d8900000000000009</span>
<span class="c1"># Status: Downloaded newer image for mcr.microsoft.com/azure-cli:latest</span>
<span class="c1"># bash-5.1# az</span>
<span class="c1"># </span>
<span class="c1"># Welcome to Azure CLI!</span>
<span class="c1"># ---------------------</span>
<span class="c1"># Use `az -h` to see available commands or go to https://aka.ms/cli.</span>
<span class="c1"># </span>
<span class="c1"># Telemetry</span>
<span class="c1"># ---------</span>
<span class="c1"># The Azure CLI collects usage data in order to improve your experience.</span>
<span class="c1"># The data is anonymous and does not include commandline argument values.</span>
<span class="c1"># The data is collected by Microsoft.</span>
<span class="c1"># </span>
<span class="c1"># You can change your telemetry settings with `az configure`.</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#      /\</span>
<span class="c1">#     /  \    _____   _ _  ___ _</span>
<span class="c1">#    / /\ \  |_  / | | | \&#39;__/ _\</span>
<span class="c1">#   / ____ \  / /| |_| | | |  __/</span>
<span class="c1">#  /_/    \_\/___|\__,_|_|  \___|</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># Welcome to the cool new Azure CLI!</span>
<span class="c1">#</span>
<span class="c1"># this optional step, if you have more than one subscription, </span>
<span class="c1"># you should set the default subscription, </span>
<span class="c1"># which will be used for the remaining Azure CLI commands.</span>
<span class="c1"># ~$ az account set --subscription XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</span>
<span class="c1">#</span>
<span class="nb">export</span> <span class="nv">tenantId</span><span class="o">=</span><span class="s1">&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
<span class="nb">export</span> <span class="nv">webAppName</span><span class="o">=</span><span class="s1">&#39;tweb1app&#39;</span>
<span class="nb">export</span> <span class="nv">resGroup</span><span class="o">=</span><span class="s1">&#39;tweb1-resgrp&#39;</span>
<span class="nb">export</span> <span class="nv">location</span><span class="o">=</span><span class="s1">&#39;northeurope&#39;</span>
<span class="nb">export</span> <span class="nv">servicePlan</span><span class="o">=</span><span class="s1">&#39;tweb1-freeplan&#39;</span>
<span class="nb">export</span> <span class="nv">tier</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span>
<span class="nb">export</span> <span class="nv">containerImg</span><span class="o">=</span><span class="s1">&#39;DOCKER|dockeruser/myrepo:tweb1&#39;</span>
<span class="nb">export</span> <span class="nv">dockerUsr</span><span class="o">=</span><span class="s1">&#39;dockeruser&#39;</span>
<span class="nb">export</span> <span class="nv">dockerPass</span><span class="o">=</span><span class="s1">&#39;xxxxxxxxxxx&#39;</span> 
<span class="c1">#</span>
az login --tenant <span class="nv">$tenantId</span> 
<span class="c1"># bash-5.1# az login --tenant $tenantId</span>
<span class="c1"># Not able to launch a browser to log you in, falling back to device code...</span>
<span class="c1"># To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DA5EFUFVL to authenticate.</span>
<span class="c1">#</span>
<span class="c1"># create new resource group</span>
az group create --name <span class="nv">$resGroup</span> --location <span class="nv">$location</span>
<span class="c1"># create new app service plan Free tier (sku:F1)</span>
az appservice plan create -n <span class="nv">$servicePlan</span> -g <span class="nv">$resGroup</span> --sku <span class="nv">$tier</span> --is-linux
<span class="c1"># create new web app (Note: as of 2021-08-28 this command can not configure private-docker-hub-conatiner image deployments so after this command you need to issue another config-container-set command to reach desired configuration.)</span>
az webapp create -n <span class="nv">$webAppName</span> -g <span class="nv">$resGroup</span> -p <span class="nv">$servicePlan</span> -i <span class="nv">$containerImg</span> -s <span class="nv">$dockerUsr</span> -w <span class="nv">$dockerPass</span> --tags <span class="nv">Lifecycle</span><span class="o">=</span>Test
az webapp stop --name <span class="nv">$webAppName</span> --resource-group <span class="nv">$resGroup</span>
<span class="c1">#</span>
az webapp config container <span class="nb">set</span> --name <span class="nv">$webAppName</span> --resource-group <span class="nv">$resGroup</span> --docker-custom-image-name <span class="s1">&#39;DOCKER|dockeruser/myrepo:tweb1&#39;</span> --docker-registry-server-url <span class="s1">&#39;https://index.docker.io/v1&#39;</span> --docker-registry-server-user <span class="s1">&#39;dockeruser&#39;</span> --docker-registry-server-password <span class="s1">&#39;xxxxxxxxxxx&#39;</span>
<span class="c1">#</span>
az ad app create --display-name <span class="nv">$webAppName</span> --available-to-other-tenants <span class="nb">false</span> --key-type Password --password <span class="s1">&#39;111xxxxxxxxxxxx11_1111xxxx1x&#39;</span> --reply-urls <span class="s1">&#39;https://tweb1app.azurewebsites.net/auth/azureadv2/callback&#39;</span>
<span class="c1">#</span>
az webapp stop --name <span class="nv">$webAppName</span> --resource-group <span class="nv">$resGroup</span>
<span class="c1"># a custom startup command for docker container</span>
az webapp config <span class="nb">set</span> --resource-group <span class="nv">$resGroup</span> --name <span class="nv">$webAppName</span> --startup-file <span class="s1">&#39;/tweb1 -k sample_param-value,1714&#39;</span>
<span class="c1"># configure web app settings, get the value for APPLICATION_ID which you can find inside of resulted json output from `az ad create` command like: &#34;appId&#34;: &#34;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#34;  </span>
az webapp config appsettings <span class="nb">set</span> --resource-group <span class="nv">$resGroup</span> --name <span class="nv">$webAppName</span> --settings <span class="nv">APPLICATION_ID</span><span class="o">=</span><span class="s1">&#39;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span>
az webapp config appsettings <span class="nb">set</span> --resource-group <span class="nv">$resGroup</span> --name <span class="nv">$webAppName</span> --settings <span class="nv">AD_TENANT_ID</span><span class="o">=</span><span class="nv">$tenantId</span>
az webapp config appsettings <span class="nb">set</span> --resource-group <span class="nv">$resGroup</span> --name <span class="nv">$webAppName</span> --settings <span class="nv">REDIRECT_URI</span><span class="o">=</span><span class="s1">&#39;https://tweb1app.azurewebsites.net/auth/azureadv2/callback&#39;</span>
az webapp config appsettings <span class="nb">set</span> --resource-group <span class="nv">$resGroup</span> --name <span class="nv">$webAppName</span> --settings <span class="nv">MICROSOFT_PROVIDER_AUTHENTICATION_SECRET</span><span class="o">=</span><span class="s1">&#39;111xxxxxxxxxxxx11_1111xxxx1x&#39;</span>
<span class="c1">#</span>
az webapp start --name <span class="nv">$webAppName</span> --resource-group <span class="nv">$resGroup</span>
</code></pre></div></article><section class="article labels"><a class="category" href=/categories/devops/>devops</a><a class="category" href=/categories/azure/>azure</a><a class="tag" href=/tags/go/>go</a><a class="tag" href=/tags/docker/>docker</a><a class="tag" href=/tags/azure/>azure</a></section><section class="article author"><a class="site home" href="/"><img class="avatar" src="/assets/img/crank.svg" alt></a><br/><div class="bio">速 (speed)</div><div class="details"><a class="item" href="https://github.com/oyundev" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;oyundev</a><a class="item" href="https://twitter.com/oyundev" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-twitter"></span>&nbsp;@oyundev</a></div>
</section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/post/directory-usage/"><span class="iconfont icon-article"></span>Faster Directory Size Calculator</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">© oyundev.com</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a></p></div>
</section></body>

</html>